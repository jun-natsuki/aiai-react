<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AiAi — 한·일 결혼/교제 매칭 (MVP)</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://dvwbrfknrptjepolbbwy.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR2d2JyZmtucnB0amVwb2xiYnd5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NDE0OTUsImV4cCI6MjA3MjIxNzQ5NX0.qRkMGQaQhWM97TiTHj5orCfxKKWA1m_amxzForDq43g";
    let sb = null;
    if (window.supabase) {
      sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }
  </script>
  <style>
    /* ---------- Design tokens ---------- */
    :root{
      --bg:#ffffff;
      --panel:#ffffff;
      --card:#ffffff;
      --muted:#6b7280;
      --text:#0b0f19;
      --accent:#111111;
      --accent-2:#e5e7eb;
      --good:#16a34a;
      --bad:#dc2626;
      --border:#e5e7eb;
      --shadow: 0 8px 30px rgba(0,0,0,.06);
      --radius: 16px;
    }

    /* ---------- Base ---------- */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#f0f4f8,#fff);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,'Noto Sans KR','Apple SD Gothic Neo',Arial,sans-serif}
    a{color:inherit}

    /* ---------- Header / Nav ---------- */
    header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.9);backdrop-filter:blur(8px);border-bottom:1px solid var(--border)}
    .bar{max-width:1100px;margin:auto;display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 16px}
    .brand{font-weight:800;letter-spacing:.2px;display:flex;align-items:center;gap:12px;text-decoration:none}
    .brand .brand-sub{font-size:18px;line-height:1.2}

    nav{display:flex;gap:18px;flex-wrap:wrap;align-items:center}
    .navlink{display:inline-flex;align-items:center;font-size:16px;font-weight:700;background:transparent;border:none;padding:8px 0;color:var(--text);cursor:pointer;text-decoration:none}
    .navlink:hover{text-decoration:underline}
    .navlink[aria-current="page"]{text-decoration:underline 2px}

    /* ---------- Layout ---------- */
    main.container{max-width:1100px;margin:20px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:22px;box-shadow:var(--shadow)}
    .hero{text-align:center;display:grid;grid-template-columns:1fr;gap:16px}
    #home > .card{margin:16px 0}

    .grid{display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:12px}
    .sm-3{grid-column:span 3}
    .sm-4{grid-column:span 4}
    .sm-6{grid-column:span 6}
    .sm-8{grid-column:span 8}
    .sm-12{grid-column:span 12}

    .features-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    .feat{display:flex;gap:12px;align-items:flex-start;padding:14px;border:1px solid var(--border);border-radius:12px}
    .feat .ico{font-size:22px;line-height:1}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

    /* ---------- Type helpers ---------- */
    .kicker{font-size:14px;color:var(--muted);margin:0 0 8px}
    .headline{font-size:36px;line-height:1.2;margin:0 0 10px;color:#0b0f19}
    .sub{color:#4b5563;margin:0 0 14px}
    .muted{color:var(--muted)}
    .help{font-size:14px;color:var(--muted)}
    .divider{height:1px;background:var(--border);margin:16px 0}

    /* ---------- Buttons ---------- */
    .btn{appearance:none;border:1px solid var(--border);background:#fff;color:#111;padding:10px 14px;border-radius:999px;cursor:pointer;font-weight:700;transition:transform .15s,box-shadow .15s}
    .btn:hover{background:#fafafa;transform:scale(1.05);box-shadow:0 2px 6px rgba(0,0,0,.1)}
    .primary{border-color:#111;background:#111;color:#fff}
    .primary:hover{opacity:.9}
    .ghost{background:transparent}

    .navlink,.brand{transition:transform .15s}
    .navlink:hover,.brand:hover{transform:scale(1.05)}
    .brand{cursor:pointer}

    /* ---------- Forms ---------- */
    .input-row{display:flex;flex-direction:column;gap:6px;margin:10px 0}
    label.req::after{content:' *';color:var(--bad)}
    input,select{width:100%;padding:12px 12px;border:1px solid var(--border);border-radius:12px;font-size:16px}
    .sticky-cta{position:sticky;bottom:10px;justify-content:flex-end;background:linear-gradient(180deg,rgba(255,255,255,0),#fff 40%);padding-top:8px}

    /* ---------- Badges ---------- */
    .badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);font-weight:700;font-size:13px}
    .badge.warn{background:#fffbea;border-color:#fef3c7;color:#92400e}
    .badge.good{background:#ecfdf5;border-color:#d1fae5;color:#065f46}

    /* ---------- Avatars / Pills / Lists ---------- */
    .avatar{width:72px;height:72px;border-radius:14px;border:1px solid var(--border);object-fit:cover;background:#fff}
    .list{display:flex;flex-direction:column;gap:6px}
    .pill{display:flex;align-items:center;justify-content:space-between;gap:6px;border:1px solid var(--border);border-radius:8px;padding:6px 10px;font-size:14px;width:100%;white-space:nowrap}
    .chat-row{display:flex;align-items:flex-end;margin:6px 0}
    .bubble{padding:8px 12px;border-radius:16px;max-width:70%;word-wrap:break-word}
    .mine{background:#2563eb;color:#fff;margin-left:auto}
    .theirs{background:#e5e7eb;color:#111}
    .chat-avatar{width:32px;height:32px;border-radius:50%;margin:0 6px;object-fit:cover}

    /* ---------- Toast ---------- */
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:999px;display:none;z-index:20}

    /* ---------- Modal ---------- */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:30}
    .modal .inner{background:#fff;border-radius:16px;border:1px solid var(--border);padding:18px;max-width:420px;width:90%}

    /* ---------- Footer ---------- */
    footer{border-top:1px solid var(--border);background:#fff}
    footer .foot-wrap{max-width:1100px;margin:0 auto;padding:18px 16px;display:flex;justify-content:center;gap:12px;flex-wrap:wrap}

    /* ---------- Responsive ---------- */
    @media (max-width: 900px){
      .features-grid{grid-template-columns:1fr 1fr}
      .sm-3,.sm-4,.sm-6,.sm-8{grid-column:span 12}
      .headline{font-size:30px}
    }
    @media (max-width: 520px){
      .features-grid{grid-template-columns:1fr}
      .brand .brand-sub{font-size:16px}
    }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <a class="brand" href="#home" onclick="event.preventDefault(); ui.go('home');">
        <!-- 로고 이미지 제거(요청) -->
        <span class="brand-sub">Ai<b>Ai</b> 아이아이 • <span lang="ja">相愛</span> • 한일결혼정보</span>
      </a>
      <div class="row" style="gap:8px;align-items:center">
        <div id="userBadge" class="badge warn" data-i18n="badgeLoggedOut"></div>
        <select id="langSel">
          <option value="ko">한국어</option>
          <option value="ja">日本語</option>
        </select>
      </div>
    </div>
    <div class="bar" style="padding-top:0">
      <nav>
        <a id="nav-home" class="navlink" data-i18n="navHome" href="#home" onclick="event.preventDefault(); ui.go('home');">홈</a>
        <a id="nav-login" class="navlink" data-i18n="navLogin" href="#auth" onclick="event.preventDefault(); ui.openAuth();">로그인</a>
        <a id="nav-profile" class="navlink" data-i18n="navProfile" href="#profile" onclick="event.preventDefault(); ui.goProtected('profile');">프로필</a>
        <a id="nav-match" class="navlink" data-i18n="navMatch" href="#match" onclick="event.preventDefault(); ui.goProtected('match');">매칭</a>
        <a id="nav-chat" class="navlink" data-i18n="navChat" href="#chat" onclick="event.preventDefault(); ui.goProtected('chat');">대화</a>
        <a id="nav-logout" class="navlink" data-i18n="navLogout" href="#logout" onclick="event.preventDefault(); ui.logout();" style="display:none">로그아웃</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- HOME -->
    <section id="home">
      <div class="card hero">
        <div>
          <p class="kicker">AiAi — Korea ⇔ Japan</p>
          <h1 class="headline" data-i18n="heroTitle">간단히 시작하는 <b>진지한 만남</b></h1>
          <p class="sub" data-i18n="heroSub">AI 1차 점수 + 매니저 최종 매칭. <b>10분 내 매칭</b>을 약속하는 한·일 결혼/교제 서비스.</p>
          <div class="row" style="justify-content:center">
            <button id="start-btn" class="btn primary" data-i18n="start" onclick="ui.start()">지금 시작하기</button>
          </div>
        </div>
        <div>
          <p class="kicker" data-i18n="taglineTitle">예비 신부들이 당신을 기다리고 있습니다.</p>
          <p class="sub" data-i18n="taglineDesc">문화 교류의 활발화, 항공편의 발달, K-POP과 애니메이션 인기 등으로 한일 결혼 성사율이 빠르게 높아지고 있습니다.</p>
        </div>
      </div>
      <div id="profileCTA" class="card" style="display:none;text-align:center">
        <p class="sub" data-i18n="profileCtaMsg">먼저 프로필을 작성하세요</p>
        <button class="btn primary" data-i18n="profileCtaBtn" onclick="ui.go('profile')">프로필 작성</button>
      </div>

      <div class="card features">
        <h2 style="margin-top:0" data-i18n="featuresTitle">AiAi의 강점</h2>
        <div class="features-grid">
          <div class="feat"><div class="ico">⏱️</div><div><b data-i18n="feat1Title">10분 내 매칭</b><div class="muted" data-i18n="feat1Desc">AI 스코어링 후 매니저가 최종 선택</div></div></div>
          <div class="feat"><div class="ico">🗣️</div><div><b data-i18n="feat2Title">자동 번역 채팅</b><div class="muted" data-i18n="feat2Desc">KO⇄JA 실시간 대화로<br>상대의 호감을 먼저 확인하세요</div></div></div>
          <div class="feat"><div class="ico">🛡️</div><div><b data-i18n="feat3Title">안전 검증</b><div class="muted" data-i18n="feat3Desc">본인인증 + 운영자 검수</div></div></div>
          <div class="feat"><div class="ico">🎯</div><div><b data-i18n="feat4Title">정교한 이상형</b><div class="muted" data-i18n="feat4Desc">성격 매트릭스로 자신과<br>가장 잘 맞는 사람을 찾아보세요</div></div></div>
          <div class="feat"><div class="ico">🌏</div><div><b data-i18n="feat5Title">한·일 국제 결혼 지원</b><div class="muted" data-i18n="feat5Desc">결혼 관련 법률/서류,<br>걱정하지 마세요</div></div></div>
          <div class="feat"><div class="ico">📅</div><div><b data-i18n="feat6Title">만남 스케줄링</b><div class="muted" data-i18n="feat6Desc">오프라인/ZOOM 일정 조율</div></div></div>
        </div>
      </div>

      <div class="card">
        <h2 style="margin-top:0" data-i18n="whyTitle">왜 AiAi인가요?</h2>
        <div class="grid">
          <div class="sm-4 card"><h3 data-i18n="why1Title">① 10분 내 매칭</h3><p class="muted" data-i18n="why1Desc">AI 점수로 상위 후보 선별 후 매니저가 최종 선택.</p></div>
          <div class="sm-4 card"><h3 data-i18n="why2Title">② 번역 걱정 끝</h3><p class="muted" data-i18n="why2Desc">대화창에서 자동 번역(모의)로 언어 장벽 최소화.</p></div>
          <div class="sm-4 card"><h3 data-i18n="why3Title">③ 안심 서비스</h3><p class="muted" data-i18n="why3Desc">본인인증과 운영자 검수로 유령 계정/리스크 감소.</p></div>
        </div>
      </div>

      <div class="card">
        <h2 style="margin-top:0" data-i18n="flowTitle">이용 순서</h2>
        <div class="grid">
          <div class="sm-3 card"><h3 data-i18n="flow1Title">1. 가입/인증</h3><p class="muted" data-i18n="flow1Desc">이메일·비번 입력 후 인증.</p></div>
          <div class="sm-3 card"><h3 data-i18n="flow2Title">2. 정보 기입</h3><p class="muted" data-i18n="flow2Desc">기본·내 프로필·이상형 프로필 3단계.</p></div>
          <div class="sm-3 card"><h3 data-i18n="flow3Title">3. 매칭 신청</h3><p class="muted" data-i18n="flow3Desc">후보 5명 추천 → 선택.</p></div>
          <div class="sm-3 card"><h3 data-i18n="flow4Title">4. 대화/만남</h3><p class="muted" data-i18n="flow4Desc">자동 번역 채팅·만남 조율.</p></div>
        </div>
      </div>
    </section>

    <!-- AUTH -->
    <section id="auth" style="display:none">
      <div id="loginBox" class="card">
        <h2 style="margin-top:0" data-i18n="loginTitle">로그인</h2>
        <div class="input-row"><label data-i18n="emailLabel">이메일</label><input id="li_email" type="email" data-i18n-placeholder="emailPH" required></div>
        <div class="input-row"><label data-i18n="pwLabel">비밀번호</label><input id="li_pw" type="password" data-i18n-placeholder="pwPH" required></div>
        <div class="row">
          <button class="btn primary" data-i18n="loginBtn" onclick="auth.login()">로그인</button>
        </div>
        <div id="li_msg" class="help"></div>
        <div class="divider"></div>
        <button class="btn ghost" data-i18n="signupLink" onclick="ui.showSignup()">회원가입</button>
      </div>

      <div id="signupBox" class="card" style="display:none">
        <h2 style="margin-top:0" data-i18n="signupTitle">기본 정보 기입</h2>
        <div class="help" data-i18n="signupHelp">가입→기본 정보→내 프로필→이상형 프로필 순으로 진행됩니다. <b>자세히 입력할수록 매칭될 확률이 높습니다.</b></div>
        <div class="row" style="justify-content:flex-end;margin-bottom:8px">
          <button class="btn ghost" data-i18n="backLogin" onclick="ui.showLogin()">로그인으로 돌아가기</button>
        </div>
        <div class="input-row"><label class="req" data-i18n="emailLabel">이메일</label><input id="su_email" type="email" data-i18n-placeholder="emailPH" placeholder="you@example.com" required></div>
        <div class="input-row"><label class="req" data-i18n="nickLabel">닉네임</label><input id="su_nick" data-i18n-placeholder="nickPH" placeholder="별명" required minlength="2" maxlength="20"></div>
        <div class="input-row"><label class="req" data-i18n="pwLabel">비밀번호</label><input id="su_pw" type="password" data-i18n-placeholder="pwPH" placeholder="8자 이상" required minlength="8"></div>
        <div class="divider"></div>
        <h3 data-i18n="verifyTitle">본인인증(모의)</h3>
        <div class="input-row"><label data-i18n="verifyMethod">연락수단</label>
          <select id="su_verify_type"><option value="sms" data-i18n-option="verifySMS">휴대폰(SMS)</option><option value="email" data-i18n-option="verifyEmail">이메일</option></select>
        </div>
        <div class="input-row"><label data-i18n="contactLabel">연락처</label><input id="su_verify_target" data-i18n-placeholder="contactPH" placeholder="010-0000-0000 / you@example.com"></div>
        <div class="row">
          <button class="btn ghost" data-i18n="sendCode" onclick="auth.sendCode()">인증코드 전송(모의)</button>
          <input id="su_code" data-i18n-placeholder="codePH" placeholder="인증코드 6자리" style="width:160px">
          <button class="btn ghost" data-i18n="verifyBtn" onclick="auth.verifyCode()">인증 확인</button>
        </div>
        <div id="su_verify_msg" class="help"></div>
        <div class="divider"></div>
        <h3 data-i18n="basicInfoTitle">기본 정보</h3>
        <div class="input-row"><label class="req" data-i18n="genderLabel">성별</label>
          <select id="ob_gender"><option value="male" data-i18n-option="male">남성</option><option value="female" data-i18n-option="female">여성</option></select>
        </div>
        <div class="input-row"><label class="req" data-i18n="birthLabel">출생년도</label><input id="ob_birth" type="number" min="1950" max="2010" data-i18n-placeholder="birthPH" placeholder="1998"></div>
        <div class="input-row"><label class="req" data-i18n="countryLabel">국가</label>
          <select id="ob_country"><option value="KR" data-i18n-option="kr">대한민국</option><option value="JP" data-i18n-option="jp">일본</option></select>
        </div>
        <div class="input-row">
          <label style="display:flex;align-items:center;gap:8px;align-self:flex-start">
            <input id="su_tos" type="checkbox">
            <span data-i18n="tosAgree">서비스 약관에 동의합니다</span>
          </label>
        </div>
        <div class="row sticky-cta"><button class="btn primary" data-i18n="signupBtn" onclick="auth.signup()">계정 생성</button></div>
      </div>
    </section>

    <!-- PROFILE (SELF INFO) -->
    <section id="profile" class="card" style="display:none">
      <h2 data-i18n="profileTitle">내 프로필</h2>
      <div class="help" data-i18n="detailHelp"><b>자세히 입력할수록 매칭될 확률이 높습니다.</b></div>
      <div class="help" data-i18n="profilePrivacy">지금 입력하고 있는 정보들은 매칭에만 활용하며 상대는 기본 정보만 열람할 수 있습니다. 서로의 정보에 대해서는 매칭 이후 자유롭게 대화를 나눌 수 있습니다. 이용자의 정보는 개인정보보호법에 의해 보호됩니다.</div>
      <div class="grid">
        <div class="sm-6 card">
          <div class="row">
            <img id="pf_avatar" class="avatar" 
     src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==" 
     alt="avatar" />
            <div class="help" data-i18n="avatarHelp">정면 증명사진 권장. 데모에서는 로컬 파일만 미리보기.</div>
          </div>
          <div class="input-row"><label data-i18n="realnameLabel">이름(실명)</label><input id="pf_realname" data-i18n-placeholder="realnamePH" placeholder="홍길동"></div>
          <div class="input-row"><label data-i18n="photoLabel">사진 업로드</label><input id="pf_photo" type="file" accept="image/*"></div>
          <div class="input-row"><label data-i18n="ageLabel">나이</label><input id="pf_age" type="number" min="18" max="100" required></div>
          <div class="help" data-i18n="ageNote"></div>
          <div class="input-row"><label data-i18n="jobLabel">직업</label><input id="pf_job" data-i18n-placeholder="jobPH" placeholder="직업"></div>
          <div class="input-row"><label data-i18n="incomeLabel">연봉(만원)</label><input id="pf_income" type="number" step="100" min="0" data-i18n-placeholder="incomePH" placeholder="예: 4200" required></div>
          <div class="input-row"><label data-i18n="heightLabel">키(cm)</label><input id="pf_height" type="number" step="1" min="120" max="220" data-i18n-placeholder="heightPH" placeholder="예: 175" required></div>
          <div class="input-row"><label data-i18n="bodyLabel">체형</label>
            <select id="pf_body"><option data-i18n-option="slender">슬렌더</option><option data-i18n-option="average">보통</option><option data-i18n-option="chubby">살집 있음</option></select>
          </div>
          <div class="input-row"><label data-i18n="mbtiLabel">MBTI</label>
            <select id="pf_mbti"></select>
          </div>
          <div class="input-row"><label data-i18n="religionLabel">종교</label>
            <select id="pf_religion"><option data-i18n-option="noReligion">무교</option><option data-i18n-option="christian">기독교</option><option data-i18n-option="catholic">천주교</option><option data-i18n-option="buddhist">불교</option><option data-i18n-option="etc">기타</option></select>
          </div>
          <div class="input-row"><label data-i18n="eduLabel">학력</label>
            <select id="pf_edu"><option data-i18n-option="highschool">고졸</option><option data-i18n-option="college">전문대졸</option><option data-i18n-option="university">대졸</option><option data-i18n-option="graduate">대학원 이상</option></select>
          </div>
          <div class="input-row"><label data-i18n="smokeLabel">흡연</label>
            <select id="pf_smoke"><option data-i18n-option="smokeNo">비흡연</option><option data-i18n-option="smokeSometimes">가끔</option><option data-i18n-option="smokeYes">흡연</option></select>
          </div>
          <div class="input-row"><label data-i18n="drinkLabel">음주</label>
            <select id="pf_drink"><option data-i18n-option="drinkNo">비음주</option><option data-i18n-option="drinkSometimes">가끔</option><option data-i18n-option="drinkOften">자주</option></select>
          </div>
          <div class="input-row"><label data-i18n="childLabel">자녀 계획</label>
            <select id="pf_child"><option data-i18n-option="childYes">원함</option><option data-i18n-option="childMaybe">아직 미정</option><option data-i18n-option="childNo">원하지 않음</option></select>
          </div>
          <div class="input-row"><label data-i18n="hobbyLabel">취미(자유)</label><input id="pf_hobby" data-i18n-placeholder="hobbyPH" placeholder="등산, 카페, 게임…"></div>
          <div class="input-row"><label data-i18n="bioLabel">한마디 소개</label><input id="pf_bio" data-i18n-placeholder="bioPH" placeholder="본인을 한마디로…"></div>
          <button class="btn primary" data-i18n="save" onclick="data.saveProfile()">저장</button>
        </div>
        <div class="sm-6 card">
          <h3 data-i18n="matrixTitle">성격 매트릭스(카테고리별 최대 3개)</h3>
          <div id="matrix"></div>
          <div class="divider"></div>
          <button class="btn ghost" data-i18n="clearSelection" onclick="matrix.clear()">선택 초기화</button>
        </div>
      </div>
      <div class="sticky-cta row"><button class="btn primary" data-i18n="nextPrefs" onclick="ui.nextFromStep2()">다음: 이상형 프로필</button></div>
    </section>

    <!-- PREFERENCES (IDEAL TYPE) -->
    <section id="prefs" class="card" style="display:none">
      <h2 data-i18n="prefsTitle">이상형 프로필</h2>
      <div class="help" data-i18n="detailHelp"><b>자세히 입력할수록 매칭될 확률이 높습니다.</b></div>
      <div class="grid">
        <div class="sm-6 card">
          <div class="input-row"><label data-i18n="prefAgeLabel">나이 선호</label>
            <select id="pr_age_type"><option data-i18n-option="sameAge">동갑</option><option data-i18n-option="younger">연하</option><option data-i18n-option="older">연상</option></select>
          </div>
          <div class="row">
            <input id="pr_age_min" type="number" style="width:100px" data-i18n-placeholder="minPH" placeholder="최소">
            <input id="pr_age_max" type="number" style="width:100px" data-i18n-placeholder="maxPH" placeholder="최대">
          </div>
          <div class="help" data-i18n="prefAgeHelp"></div>
          <div class="input-row"><label data-i18n="incomeMin">연봉 최소(만원)</label><input id="pr_income_min" type="number" step="100"></div>
          <div class="input-row"><label data-i18n="heightRange">키 범위(cm)</label>
            <div class="row"><input id="pr_height_min" type="number" style="width:100px" data-i18n-placeholder="minPH" placeholder="최소"><input id="pr_height_max" type="number" style="width:100px" data-i18n-placeholder="maxPH" placeholder="최대"></div>
          </div>
          <div class="input-row"><label data-i18n="bodyLabel">체형</label>
            <select id="pr_body"><option data-i18n-option="any">무관</option><option data-i18n-option="slender">슬렌더</option><option data-i18n-option="average">보통</option><option data-i18n-option="chubby">살집 있음</option></select>
          </div>
          <div class="input-row"><label data-i18n="mbtiLabel">MBTI</label>
            <select id="pr_mbti"><option data-i18n-option="any">무관</option></select>
          </div>
          <div class="input-row"><label data-i18n="prefHobbyLabel">취미(희망)</label><input id="pr_hobby" data-i18n-placeholder="prefHobbyPH" placeholder="상대 취미 희망"></div>
        </div>
        <div class="sm-6 card">
          <h3 data-i18n="prefMatrixTitle">성격 선호(카테고리별 3개)</h3>
          <div id="matrixPref"></div>
          <label class="row" style="margin-top:8px"><input id="pr_deal" type="checkbox"> <span data-i18n="dealbreaker">선택 조건을 필수(Dealbreaker)로 적용</span></label>
          <div class="divider"></div>
          <button class="btn ghost" data-i18n="clearSelection" onclick="matrixPref.clear()">선택 초기화</button>
        </div>
      </div>
      <div class="sticky-cta row"><button class="btn primary" data-i18n="save" onclick="data.savePrefs()">저장</button></div>
    </section>

    <!-- MATCHING -->
    <section id="match" class="card" style="display:none">
      <h2 data-i18n="matchTitle">5. 매칭</h2>
      <div class="help" data-i18n="matchHelp">버튼을 누르면 AI 점수(모의)로 상위 후보를 고르고, 매니저 최종 선택을 시뮬레이션합니다.</div>
      <div class="row" style="margin:8px 0">
        <button class="btn primary" data-i18n="matchRequest" onclick="engine.match()">매칭 신청</button>
        <span id="match_msg" class="help"></span>
      </div>
      <div id="match_results" class="grid"></div>
    </section>

    <!-- CHAT -->
    <section id="chat" class="card" style="display:none">
      <h2 data-i18n="chatTitle">6. 대화 + 자동 번역(모의)</h2>
      <div class="help" data-i18n="chatHelp">실서비스에서는 번역 API(Google/DeepL 등) 연동. 데모는 언어 감지/번역을 <b>흉내</b>냅니다.</div>
      <div class="grid">
        <div class="sm-8 card">
          <div id="chat_log" style="height:260px;overflow:auto;border:1px solid var(--border);border-radius:12px;padding:8px;background:#fff"></div>
          <div class="row" style="margin-top:8px">
            <input id="chat_input" data-i18n-placeholder="chatPlaceholder" placeholder="메시지를 입력…" style="flex:1">
            <button class="btn primary" data-i18n="send" onclick="chat.send()">보내기</button>
            <label class="row" style="align-items:center;gap:6px;margin-left:8px">
              <input id="enter_send" type="checkbox" checked> <span data-i18n="enterSend">엔터로 전송</span>
            </label>
          </div>
        </div>
        <div class="sm-4 card">
          <h3 data-i18n="meetingTitle">7. 만남 신청</h3>
          <p class="help" data-i18n="meetingHelp">양측이 모두 동의하면 오프라인/온라인(ZOOM) 중 선택하여 스케줄 조율.</p>
          <div class="row">
            <button class="btn ghost" data-i18n="meetOffline" onclick="chat.requestMeet('offline')">오프라인 만남 신청</button>
            <button class="btn ghost" data-i18n="meetOnline" onclick="chat.requestMeet('online')">ZOOM 만남 신청</button>
          </div>
          <div id="meet_status" class="help" style="margin-top:8px"></div>
        </div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast"></div>

  <!-- Modal: 로그인 필요 -->
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="inner" tabindex="-1">
      <h3 id="modalTitle" data-i18n="modalTitle">로그인 이후 사용 가능합니다</h3>
      <p class="help" data-i18n="modalHelp">계정으로 로그인 또는 신규 가입 후 이용하세요.</p>
      <div class="row" style="margin-top:8px">
        <button class="btn primary" data-i18n="modalLogin" onclick="ui.openAuth();ui.hideModal()">로그인 하러 가기</button>
        <button class="btn ghost" data-i18n="modalClose" onclick="ui.hideModal()">닫기</button>
      </div>
    </div>
  </div>

  <footer>
    <div class="foot-wrap">
      <span class="muted">© 2025 AiAi</span>
      <span class="muted">｜</span>
      <a href="#home" class="muted" data-i18n="footHome" onclick="event.preventDefault(); ui.go('home');">홈</a>
      <span class="muted">｜</span>
      <a href="#auth" class="muted" data-i18n="footStart" onclick="event.preventDefault(); ui.openAuth();">시작하기</a>
    </div>
  </footer>

  <script>
    // ---- Utilities ----
    const $ = sel => document.querySelector(sel);
    const el = (tag, attrs={}, children=[])=>{const n=document.createElement(tag);Object.entries(attrs).forEach(([k,v])=>{if(k==='class') n.className=v; else if(k==='html') n.innerHTML=v; else if(k==='style') n.setAttribute('style',v); else n.setAttribute(k,v)});children.forEach(c=>n.appendChild(c));return n};
    const toast=(msg)=>{const t=$('#toast');t.textContent=msg;t.style.display='block';setTimeout(()=>t.style.display='none',1800)};
    const store={get:(k,d)=>{try{return JSON.parse(localStorage.getItem(k))??d}catch(e){return d}},set:(k,v)=>localStorage.setItem(k,JSON.stringify(v)),del:(k)=>localStorage.removeItem(k)};
    const bindEnter=(sel,fn)=>{document.querySelectorAll(sel).forEach(el=>el.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();fn();}}));};

    // ---- Supabase realtime helpers ----
    async function getMe(){
      const { data } = await sb.auth.getUser();
      return data.user || null;
    }

    async function fetchProfile(userId){
      const { data, error } = await sb.from('profiles').select('nickname, avatar_url').eq('user_id', userId).maybeSingle();
      if(error) throw error;
      return data;
    }

    function subscribeMyMatches(onChange){
      const ch = sb.channel('matches-live');
      ch.on('postgres_changes',{event:'*',schema:'public',table:'matches',filter:`seeker=eq.${window.__CURRENT_UID__}`}, payload=>onChange(payload.new,payload));
      ch.on('postgres_changes',{event:'*',schema:'public',table:'matches',filter:`partner=eq.${window.__CURRENT_UID__}`}, payload=>onChange(payload.new,payload));
      ch.subscribe();
      return () => sb.removeChannel(ch);
    }

    async function onMatchChanged(row){
      if(!row) return;
      const me = window.__CURRENT_UID__;
      const partnerId = row.seeker===me ? row.partner : row.seeker;
      let nickname = '(닉네임 없음)';
      try {
        const p = await fetchProfile(partnerId);
        window.__PARTNER_PROFILE__ = p;
        if(p?.nickname) nickname = p.nickname;
      } catch(err){
        console.error('프로필 조회 실패', err);
      }
      const ok = confirm(`매칭이 완료되었습니다! 상대: ${nickname}`);
      if(ok){
        try {
          const conv = await ensureConversation(partnerId);
          window.__CURRENT_CONV_ID__ = conv.id;
          await enterChat(conv.id);
          ui.go('chat');
        } catch(err){
          console.error('대화방 준비 실패', err);
        }
      }
    }

    async function ensureConversation(partnerId){
      const me = window.__CURRENT_UID__;
      const { data: existing } = await sb.from('conversations')
        .select('*')
        .or(`and(user_a.eq.${me},user_b.eq.${partnerId}),and(user_a.eq.${partnerId},user_b.eq.${me})`)
        .limit(1);
      if(existing && existing.length) return existing[0];
      const { data, error } = await sb.from('conversations')
        .insert({ user_a: me, user_b: partnerId }).select().single();
      if(error) throw error;
      return data;
    }

    let stopMatchesSub=null;
    const afterSignInHook = async (user) => {
      if(!sb) return;
      const me = user || await getMe();
      window.__CURRENT_UID__ = me?.id || null;
      if(!window.__CURRENT_UID__) return;
      if(stopMatchesSub){ stopMatchesSub(); }
      try{
        const prof = await fetchProfile(window.__CURRENT_UID__);
        if(prof) store.set('my_profile', prof);
      }catch(e){ console.error(e); }
      ui.badge();
      stopMatchesSub = subscribeMyMatches(onMatchChanged);
      try{
        const { data: rows } = await sb
          .from('matches')
          .select('*')
          .or(`seeker.eq.${window.__CURRENT_UID__},partner.eq.${window.__CURRENT_UID__}`)
          .limit(1);
        if(rows && rows.length){
          await onMatchChanged(rows[0]);
        }
      }catch(e){ console.error(e); }
    };

    const beforeSignOutHook = async () => {
      if(stopMatchesSub){ stopMatchesSub(); stopMatchesSub=null; }
      store.del('my_profile');
      window.__PARTNER_PROFILE__ = null;
      window.__CURRENT_UID__ = null;
    };

    async function sendMessage(conv_id,text,lang='ko'){
      const me=window.__CURRENT_UID__;
      const { error } = await sb.from('messages').insert({ conv_id, sender:me, text, lang });
      if(error) console.error('메시지 전송 실패:', error);
    }

    function subscribeMessages(conv_id,onNewMsg){
      const ch = sb.channel('chat-'+conv_id);
      ch.on('postgres_changes',{event:'INSERT',schema:'public',table:'messages',filter:`conv_id=eq.${conv_id}`}, payload=>onNewMsg(payload.new));
      ch.subscribe();
      return () => sb.removeChannel(ch);
    }

    function renderMessage(msg){
      const host=$('#chat_log');
      if(!host) return;
      const mine = msg.sender===window.__CURRENT_UID__;
      const row=el('div',{class:'chat-row'});
      const avatar = mine ? store.get('my_profile')?.avatar_url : window.__PARTNER_PROFILE__?.avatar_url;
      if(!mine) row.appendChild(el('img',{class:'chat-avatar',src:avatar||''}));
      row.appendChild(el('div',{class:`bubble ${mine?'mine':'theirs'}`,html:escapeHtml(msg.text)}));
      if(mine) row.appendChild(el('img',{class:'chat-avatar',src:avatar||''}));
      host.appendChild(row);
      host.scrollTop=host.scrollHeight;
    }

    let stopMsgSub=null;
    async function enterChat(conv_id){
      window.__CURRENT_CONV_ID__=conv_id;
      if(stopMsgSub){ stopMsgSub(); stopMsgSub=null; }
      stopMsgSub = subscribeMessages(conv_id, renderMessage);
      const { data } = await sb.from('messages').select('*').eq('conv_id', conv_id).order('created_at',{ascending:true});
      if(data) data.forEach(renderMessage);
    }

    // ---- I18n ----
    const messages={
      ko:{
        badgeLoggedOut:'로그아웃 상태',badgeUnverified:'인증 필요',badgeVerified:'인증됨',
        navHome:'홈',navLogin:'로그인',navProfile:'프로필',navMatch:'매칭',navChat:'대화',navLogout:'로그아웃',
        heroTitle:'간단히 시작하는 <b>진지한 만남</b>',heroSub:'AI 1차 점수 + 매니저 최종 매칭. <b>10분 내 매칭</b>을 약속하는 한·일 결혼/교제 서비스.',start:'지금 시작하기',taglineTitle:'예비 신부들이 당신을 기다리고 있습니다.',taglineDesc:'문화 교류의 활발화, 항공편의 발달, K-POP과 애니메이션 인기 등으로 한일 결혼 성사율이 빠르게 높아지고 있습니다.',profileCtaMsg:'먼저 프로필을 작성하세요',profileCtaBtn:'프로필 작성',
        featuresTitle:'AiAi의 강점',feat1Title:'10분 내 매칭',feat1Desc:'AI 스코어링 후 매니저가 최종 선택',
        feat2Title:'자동 번역 채팅',feat2Desc:'KO⇄JA 실시간 대화로<br>상대의 호감을 먼저 확인하세요',
        feat3Title:'안전 검증',feat3Desc:'본인인증 + 운영자 검수',
        feat4Title:'정교한 이상형',feat4Desc:'성격 매트릭스로 자신과<br>가장 잘 맞는 사람을 찾아보세요',
        feat5Title:'한·일 국제 결혼 지원',feat5Desc:'결혼 관련 법률/서류,<br>걱정하지 마세요',
        feat6Title:'만남 스케줄링',feat6Desc:'오프라인/ZOOM 일정 조율',
        whyTitle:'왜 AiAi인가요?',
        why1Title:'① 10분 내 매칭',why1Desc:'AI 점수로 상위 후보 선별 후 매니저가 최종 선택.',
        why2Title:'② 번역 걱정 끝',why2Desc:'대화창에서 자동 번역(모의)로 언어 장벽 최소화.',
        why3Title:'③ 안심 서비스',why3Desc:'본인인증과 운영자 검수로 유령 계정/리스크 감소.',
        flowTitle:'이용 순서',
        flow1Title:'1. 가입/인증',flow1Desc:'이메일·비번 입력 후 인증.',
        flow2Title:'2. 정보 기입',flow2Desc:'기본·내 프로필·이상형 프로필 3단계.',
        flow3Title:'3. 매칭 신청',flow3Desc:'후보 5명 추천 → 선택.',
        flow4Title:'4. 대화/만남',flow4Desc:'자동 번역 채팅·만남 조율.',
        modalTitle:'로그인 이후 사용 가능합니다',
        modalHelp:'계정으로 로그인 또는 신규 가입 후 이용하세요.',
        modalLogin:'로그인 하러 가기',
        modalClose:'닫기',
        footHome:'홈',footStart:'시작하기',
        loginTitle:'로그인',emailLabel:'이메일',pwLabel:'비밀번호',loginBtn:'로그인',signupLink:'회원가입',
        signupTitle:'기본 정보 기입',signupHelp:'가입→기본 정보→내 프로필→이상형 프로필 순으로 진행됩니다. <b>자세히 입력할수록 매칭될 확률이 높습니다.</b>',nickLabel:'닉네임',nickPH:'별명',emailPH:'you@example.com',pwPH:'8자 이상',tosLabel:'약관동의',tosAgree:'서비스 약관에 동의합니다',signupBtn:'계정 생성',verifyTitle:'본인인증(모의)',verifyMethod:'연락수단',verifySMS:'휴대폰(SMS)',verifyEmail:'이메일',contactLabel:'연락처',contactPH:'010-0000-0000 / you@example.com',sendCode:'인증코드 전송(모의)',codePH:'인증코드 6자리',verifyBtn:'인증 확인',basicInfoTitle:'기본 정보',genderLabel:'성별',male:'남성',female:'여성',birthLabel:'출생년도',birthPH:'1998',countryLabel:'국가',kr:'대한민국',jp:'일본',nextProfile:'다음: 내 프로필',backLogin:'로그인으로 돌아가기',
        profileTitle:'내 프로필',detailHelp:'<b>자세히 입력할수록 매칭될 확률이 높습니다.</b>',profilePrivacy:'지금 입력하고 있는 정보들은 매칭에만 활용하며 상대는 기본 정보만 열람할 수 있습니다. 서로의 정보에 대해서는 매칭 이후 자유롭게 대화를 나눌 수 있습니다. 이용자의 정보는 개인정보보호법에 의해 보호됩니다.',avatarHelp:'정면 증명사진 권장. 데모에서는 로컬 파일만 미리보기.',realnameLabel:'이름(실명)',realnamePH:'홍길동',photoLabel:'사진 업로드',ageLabel:'나이',jobLabel:'직업',jobPH:'직업',incomeLabel:'연봉(만원)',incomePH:'예: 4200',heightLabel:'키(cm)',heightPH:'예: 175',bodyLabel:'체형',slender:'슬렌더',average:'보통',chubby:'살집 있음',mbtiLabel:'MBTI',religionLabel:'종교',noReligion:'무교',christian:'기독교',catholic:'천주교',buddhist:'불교',etc:'기타',eduLabel:'학력',highschool:'고졸',college:'전문대졸',university:'대졸',graduate:'대학원 이상',smokeLabel:'흡연',smokeNo:'비흡연',smokeSometimes:'가끔',smokeYes:'흡연',drinkLabel:'음주',drinkNo:'비음주',drinkSometimes:'가끔',drinkOften:'자주',childLabel:'자녀 계획',childYes:'원함',childMaybe:'아직 미정',childNo:'원하지 않음',hobbyLabel:'취미(자유)',hobbyPH:'등산, 카페, 게임…',bioLabel:'한마디 소개',bioPH:'본인을 한마디로…',save:'저장',matrixTitle:'성격 매트릭스(카테고리별 최대 3개)',clearSelection:'선택 초기화',nextPrefs:'다음: 이상형 프로필',
        prefsTitle:'이상형 프로필',prefAgeLabel:'나이 선호',sameAge:'동갑',younger:'연하',older:'연상',minPH:'최소',maxPH:'최대',incomeMin:'연봉 최소(만원)',heightRange:'키 범위(cm)',any:'무관',prefHobbyLabel:'취미(희망)',prefHobbyPH:'상대 취미 희망',prefMatrixTitle:'성격 선호(카테고리별 3개)',dealbreaker:'선택 조건을 필수(Dealbreaker)로 적용',
        matchTitle:'5. 매칭',matchHelp:'버튼을 누르면 AI 점수(모의)로 상위 후보를 고르고, 매니저 최종 선택을 시뮬레이션합니다.',matchRequest:'매칭 신청',
        chatTitle:'6. 대화 + 자동 번역(모의)',chatHelp:'실서비스에서는 번역 API(Google/DeepL 등) 연동. 데모는 언어 감지/번역을 <b>흉내</b>냅니다.',chatPlaceholder:'메시지를 입력…',send:'보내기',enterSend:'엔터로 전송',meetingTitle:'7. 만남 신청',meetingHelp:'양측이 모두 동의하면 오프라인/온라인(ZOOM) 중 선택하여 스케줄 조율.',meetOffline:'오프라인 만남 신청',meetOnline:'ZOOM 만남 신청',
        toastRequired:'필수 항목을 확인하세요',toastEmailTaken:'이미 가입된 이메일입니다',toastSignupDone:'가입이 완료되었습니다',alertSignupDone:'사용자 등록이 완료되었습니다',toastNeedLogin:'먼저 가입/로그인 하세요',toastSendCode:'인증코드 전송(모의)',toastNeedCode:'코드 전송 후 시도하세요',toastVerifyDone:'본인인증 완료',alertVerifyDone:'사용자 본인인증이 완료되었습니다. 이제 더 많은 기능에 접근할 수 있습니다',toastCodeWrong:'코드가 올바르지 않습니다',loginFail:'이메일/비밀번호를 확인하세요',loginSuccess:'로그인 성공',toastLogin:'로그인',toastLogout:'로그아웃',toastBasicInfo:'기본 정보를 모두 입력하세요',toastProfileIncomplete:'내 프로필을 모두 입력하세요',toastSelectMBTI:'MBTI를 선택하세요',toastLoginNeeded:'로그인 필요',toastProfileSaved:'프로필 저장 완료',alertProfileSaved:'프로필 저장 완료',toastAgeRange:'나이 범위를 입력하세요',toastPrefsSaved:'이상형 저장 완료',toastNeedProfileSave:'프로필/이상형을 먼저 저장하세요',alertNeedProfile:'먼저 프로필 작성이 필요합니다',meetOfflineStatus:'오프라인 만남 신청 보냈습니다 (모의)',meetOnlineStatus:'ZOOM 만남 신청 보냈습니다 (모의)',ageNote:'만 나이 기준입니다.',prefAgeHelp:'나이 차이는 어느 정도가 괜찮으신가요? -1 +2와 같은 식으로 적어 주세요',toastImageType:'이미지 파일만 업로드하세요',toastImageSize:'2MB 이하 이미지만 가능합니다'
      },
      ja:{
        badgeLoggedOut:'ログアウト状態',badgeUnverified:'認証必要',badgeVerified:'認証済み',
        navHome:'ホーム',navLogin:'ログイン',navProfile:'プロフィール',navMatch:'マッチング',navChat:'チャット',navLogout:'ログアウト',
        heroTitle:'手軽に始める <b>真剣な出会い</b>',heroSub:'AIによる一次スコア + マネージャー最終マッチング。<b>10分以内にマッチング</b>を約束する日韓結婚・交際サービス。',start:'今すぐ始める',taglineTitle:'花嫁候補があなたを待っています。',taglineDesc:'文化交流の活発化や航空便の発達、K-POPやアニメの人気などにより、日韓の結婚成立率は急速に高まっています。',profileCtaMsg:'まずプロフィールを入力してください',profileCtaBtn:'プロフィール入力',
        featuresTitle:'AiAiの強み',feat1Title:'10分以内マッチング',feat1Desc:'AIスコアリング後にマネージャーが最終選択',
        feat2Title:'自動翻訳チャット',feat2Desc:'韓⇄日リアルタイム会話で<br>相手の好意を先に確かめましょう',
        feat3Title:'安全な検証',feat3Desc:'本人確認 + 運営チェック',
        feat4Title:'緻密な理想像',feat4Desc:'性格マトリックスで自分に<br>最も合う相手を探しましょう',
        feat5Title:'日韓国際結婚サポート',feat5Desc:'結婚関連の法律・書類も<br>お任せください',
        feat6Title:'出会いスケジューリング',feat6Desc:'オフライン/ZOOM日程調整',
        whyTitle:'なぜAiAiなのか?',
        why1Title:'① 10分以内マッチング',why1Desc:'AIスコアで上位候補を選別しマネージャーが最終選択。',
        why2Title:'② 翻訳の心配なし',why2Desc:'チャットで自動翻訳(デモ)により言語の壁を最小化。',
        why3Title:'③ 安心サービス',why3Desc:'本人確認と運営チェックで不正アカウント/リスク減少。',
        flowTitle:'利用手順',
        flow1Title:'1. 登録/認証',flow1Desc:'メール・パスワード入力後に認証。',
        flow2Title:'2. 情報入力',flow2Desc:'基本・プロフィール・理想プロフィールの3段階。',
        flow3Title:'3. マッチング申請',flow3Desc:'候補5人を推薦→選択。',
        flow4Title:'4. チャット/出会い',flow4Desc:'自動翻訳チャット・出会い調整。',
        modalTitle:'ログイン後に利用できます',
        modalHelp:'アカウントでログインまたは新規登録後にご利用ください。',
        modalLogin:'ログインしに行く',
        modalClose:'閉じる',
        footHome:'ホーム',footStart:'開始する',
        loginTitle:'ログイン',emailLabel:'メール',pwLabel:'パスワード',loginBtn:'ログイン',signupLink:'会員登録',
        signupTitle:'基本情報入力',signupHelp:'登録→基本情報→プロフィール→理想プロフィールの順に進みます。<b>詳しく入力するほどマッチング率が上がります。</b>',nickLabel:'ニックネーム',nickPH:'ニックネーム',emailPH:'you@example.com',pwPH:'8文字以上',tosLabel:'利用規約',tosAgree:'利用規約に同意します',signupBtn:'アカウント作成',verifyTitle:'本人確認(デモ)',verifyMethod:'連絡手段',verifySMS:'携帯電話(SMS)',verifyEmail:'メール',contactLabel:'連絡先',contactPH:'010-0000-0000 / you@example.com',sendCode:'認証コード送信(デモ)',codePH:'認証コード6桁',verifyBtn:'認証確認',basicInfoTitle:'基本情報',genderLabel:'性別',male:'男性',female:'女性',birthLabel:'生年',birthPH:'1998',countryLabel:'国',kr:'韓国',jp:'日本',nextProfile:'次: プロフィール',backLogin:'ログインへ戻る',
        profileTitle:'プロフィール',detailHelp:'<b>詳しく入力するほどマッチング率が上がります。</b>',profilePrivacy:'入力された情報はマッチングのみに利用され、相手は基本情報のみ閲覧できます。詳しい情報はマッチング後の会話で自由に共有できます。利用者の情報は個人情報保護法によって保護されます。',avatarHelp:'正面の証明写真を推奨。デモではローカルファイルのみプレビュー。',realnameLabel:'氏名',realnamePH:'山田太郎',photoLabel:'写真アップロード',ageLabel:'年齢',jobLabel:'職業',jobPH:'職業',incomeLabel:'年収(万円)',incomePH:'例: 4200',heightLabel:'身長(cm)',heightPH:'例: 175',bodyLabel:'体型',slender:'スレンダー',average:'普通',chubby:'ふくよか',mbtiLabel:'MBTI',religionLabel:'宗教',noReligion:'無宗教',christian:'キリスト教',catholic:'カトリック',buddhist:'仏教',etc:'その他',eduLabel:'学歴',highschool:'高校卒',college:'短大卒',university:'大学卒',graduate:'大学院以上',smokeLabel:'喫煙',smokeNo:'非喫煙',smokeSometimes:'時々',smokeYes:'喫煙',drinkLabel:'飲酒',drinkNo:'飲まない',drinkSometimes:'時々',drinkOften:'よく飲む',childLabel:'子ども計画',childYes:'希望する',childMaybe:'未定',childNo:'希望しない',hobbyLabel:'趣味',hobbyPH:'登山、カフェ、ゲーム…',bioLabel:'ひと言紹介',bioPH:'自己紹介を一言で…',save:'保存',matrixTitle:'性格マトリックス(各カテゴリー最大3つ)',clearSelection:'選択リセット',nextPrefs:'次: 理想プロフィール',
        prefsTitle:'理想プロフィール',prefAgeLabel:'年齢の希望',sameAge:'同い年',younger:'年下',older:'年上',minPH:'最小',maxPH:'最大',incomeMin:'最低年収(万円)',heightRange:'身長範囲(cm)',any:'指定なし',prefHobbyLabel:'趣味(希望)',prefHobbyPH:'相手に望む趣味',prefMatrixTitle:'性格の好み(各カテゴリー3つ)',dealbreaker:'選択条件を必須(ディールブレイカー)として適用',
        matchTitle:'5. マッチング',matchHelp:'ボタンを押すとAIスコア(デモ)で上位候補を選び、マネージャー最終選択をシミュレーションします。',matchRequest:'マッチング申請',
        chatTitle:'6. チャット + 自動翻訳(デモ)',chatHelp:'本サービスでは翻訳API(Google/DeepL等)を連携。デモでは言語検出/翻訳を< b>擬似</b>的に行います。',chatPlaceholder:'メッセージを入力…',send:'送信',enterSend:'Enterで送信',meetingTitle:'7. 出会い申請',meetingHelp:'双方が同意するとオフライン/オンライン(ZOOM)から日程調整します。',meetOffline:'オフライン出会い申請',meetOnline:'ZOOM出会い申請',
        toastRequired:'必須項目を確認してください',toastEmailTaken:'既に登録されたメールです',toastSignupDone:'登録が完了しました',alertSignupDone:'ユーザー登録が完了しました',toastNeedLogin:'まず登録/ログインしてください',toastSendCode:'認証コード送信(デモ)',toastNeedCode:'コード送信後に試してください',toastVerifyDone:'本人認証完了',alertVerifyDone:'本人認証が完了しました。さらに多くの機能が利用できます',toastCodeWrong:'コードが正しくありません',loginFail:'メール/パスワードを確認してください',loginSuccess:'ログイン成功',toastLogin:'ログイン',toastLogout:'ログアウト',toastBasicInfo:'基本情報をすべて入力してください',toastProfileIncomplete:'プロフィールをすべて入力してください',toastSelectMBTI:'MBTIを選択してください',toastLoginNeeded:'ログインが必要です',toastProfileSaved:'プロフィール保存完了',alertProfileSaved:'プロフィール保存完了',toastAgeRange:'年齢範囲を入力してください',toastPrefsSaved:'理想プロフィール保存完了',toastNeedProfileSave:'プロフィール/理想を先に保存してください',alertNeedProfile:'まずプロフィール入力が必要です',meetOfflineStatus:'オフライン出会いを申請しました(デモ)',meetOnlineStatus:'ZOOM出会いを申請しました(デモ)',ageNote:'',prefAgeHelp:'年齢差はどの程度がよろしいですか？ -1 +2のように記入してください',toastImageType:'画像ファイルのみアップロード可能です',toastImageSize:'2MB以下の画像のみ可能です'
      }
    };
    const i18n={
      lang:'ko',
      set(l){
        this.lang=l;
        store.set('lang',l);
        const sel=$('#langSel'); if(sel) sel.value=l;
        document.documentElement.lang=l;
        document.querySelectorAll('[data-i18n]').forEach(el=>{
          const key=el.getAttribute('data-i18n');
          if(Object.prototype.hasOwnProperty.call(messages[l],key)) el.innerHTML=messages[l][key];
        });
        document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{
          const key=el.getAttribute('data-i18n-placeholder');
          if(Object.prototype.hasOwnProperty.call(messages[l],key)) el.placeholder=messages[l][key];
        });
        document.querySelectorAll('[data-i18n-option]').forEach(el=>{
          const key=el.getAttribute('data-i18n-option');
          if(Object.prototype.hasOwnProperty.call(messages[l],key)) el.textContent=messages[l][key];
        });
        rebuildMatrices();
        ui.badge();
        const fh=document.querySelector('[data-i18n="footHome"]'); if(fh) fh.textContent=messages[l].footHome;
        const fs=document.querySelector('[data-i18n="footStart"]'); if(fs) fs.textContent=messages[l].footStart;
      },
      t(key){return messages[this.lang][key]||'';}
    };

    // ---- Auth (Supabase) ----
    const auth={
      async signup(){
        const email=$('#su_email').value?.trim();
        const nick=$('#su_nick').value?.trim();
        const pw=$('#su_pw').value;
        const tos=$('#su_tos').checked;
        const g=$('#ob_gender').value;
        const b=$('#ob_birth').value;
        const c=$('#ob_country').value;
        const vv=store.get('verify');
        if(!email||!nick||!pw||!tos){toast(i18n.t('toastRequired'));return;}
        if(!vv||!vv.ok||vv.email!==email){toast(i18n.t('toastNeedCode'));return;}
        if(!g||!b||!c){toast(i18n.t('toastBasicInfo'));return;}
        const { data, error } = await sb.auth.signUp({ email, password: pw });
        if(error){ toast(error.message); return; }
        store.set('session',email);
        store.set('last_email',email);
        store.set('last_pw',pw);
        try{
          await sb.from('profiles').upsert({ user_id:data.user.id, nickname:nick, gender:g, birth_year:+b, country:c });
        }catch(e){ console.error(e); }
        store.set('my_profile',{ nickname:nick });
        store.del('verify');
        ui.badge();
        ui.refreshNav();
        ui.homeCTA();
        await afterSignInHook(data.user);
        data.loadProfile();
        data.loadPrefs();
        ui.go('home');
        toast(i18n.t('toastSignupDone'));
        alert(i18n.t('alertSignupDone'));
      },
      sendCode(){
        const email=$('#su_email').value?.trim();
        if(!email){toast(i18n.t('toastRequired'));return;}
        const code=(Math.random()*900000+100000|0).toString();
        store.set('verify',{email,code,ts:Date.now(),ok:false});
        $('#su_verify_msg').textContent=`${i18n.t('sendCode')}: ${code}`;
        toast(i18n.t('toastSendCode'));
      },
      verifyCode(){
        const vv=store.get('verify');
        const code=$('#su_code').value?.trim();
        if(!vv){toast(i18n.t('toastNeedCode'));return;}
        if(code===vv.code){
          vv.ok=true;
          store.set('verify',vv);
          toast(i18n.t('toastVerifyDone'));
          $('#su_verify_msg').textContent=i18n.t('badgeVerified');
          alert(i18n.t('alertVerifyDone'));
        } else { toast(i18n.t('toastCodeWrong')); }
      },
      async login(){
        const email=$('#li_email').value?.trim();
        const pw=$('#li_pw').value;
        const { data, error } = await sb.auth.signInWithPassword({ email, password: pw });
        if(error){$('#li_msg').textContent=i18n.t('loginFail');return;}
        store.set('session',email);
        store.set('last_email',email);
        store.set('last_pw',pw);
        await afterSignInHook(data.user);
        $('#li_msg').textContent=i18n.t('loginSuccess');
        toast(i18n.t('toastLogin'));
        ui.refreshNav();
        ui.homeCTA();
        data.loadProfile();
        data.loadPrefs();
        ui.go('home');
      },
      async logout(){
        await sb.auth.signOut();
        const email=store.get('session');
        if(email){
          store.del('tmp_photo_'+email);
          store.del('chat_with');
          store.del('meet_req');
        }
        store.del('session');
        await beforeSignOutHook();
        ui.clearForms();
        toast(i18n.t('toastLogout'));
        ui.badge();
        ui.refreshNav();
        ui.homeCTA();
        ui.go('home');
      }
    };

    // ---- UI routing & guards ----
    const ui={
      go(id){
  document.querySelectorAll('main section[id]').forEach(s=>s.style.display='none');
  const el=document.getElementById(id); if(el){el.style.display='block'}
  const map={home:'nav-home',auth:'nav-login',profile:'nav-profile',match:'nav-match',chat:'nav-chat'};
  document.querySelectorAll('nav .navlink').forEach(a=>a.removeAttribute('aria-current'));
  const target=document.getElementById(map[id]); if(target) target.setAttribute('aria-current','page');
  window.scrollTo({top:0,behavior:'smooth'});
  if(id==='profile') data.loadProfile();
  if(id==='prefs') data.loadPrefs();
},
      goProtected(id){
        const email=store.get('session');
        if(!email){ui.showModal();return;}
        if((id==='match'||id==='chat') && !ui.hasProfile()){
          alert(i18n.t('alertNeedProfile'));
          ui.go('profile');
          return;
        }
        ui.go(id);
      },
      start(){
        const email=store.get('session');
        if(email){ui.goProtected('match');} else ui.openAuth();
      },
      openAuth(){ui.showLogin(); ui.go('auth');},
      showSignup(){
        $('#loginBox').style.display='none';
        $('#signupBox').style.display='block';
      },
      showLogin(){
        $('#signupBox').style.display='none';
        $('#loginBox').style.display='block';
      },
      badge(){
        const email=store.get('session');
        const badge=$('#userBadge');
        if(email){
        const prof=store.get('my_profile');
        const u=store.get('users',{})[email];
        const nick=prof?.nickname || prof?.nick || u?.nick || email;
          badge.textContent=`${nick}님 반갑습니다!`;
          badge.className='badge good';
        } else {
          badge.textContent=i18n.t('badgeLoggedOut');
          badge.className='badge warn';
        }
      },
      refreshNav(){
        const logged=!!store.get('session');
        $('#nav-login').style.display=logged?'none':'inline-flex';
        $('#nav-logout').style.display=logged?'inline-flex':'none';
      },
      hasProfile(){
        const email=store.get('session');
        if(!email) return false;
        const p=store.get('profiles',{})[email];
        const pref=store.get('prefs',{})[email];
        return !!p && !!pref;
      },
      homeCTA(){
        const card=$('#profileCTA');
        if(!card) return;
        const show=store.get('session') && !ui.hasProfile();
        card.style.display=show?'block':'none';
      },
      logout(){auth.logout();},
      clearForms(){
        document.querySelectorAll('input').forEach(el=>{if(el.type==='checkbox'||el.type==='radio')el.checked=false; else el.value='';});
        document.querySelectorAll('select').forEach(el=>el.selectedIndex=0);
        $('#pf_avatar').src='data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';
        ['su_verify_msg','li_msg','match_msg','meet_status'].forEach(id=>{const e=document.getElementById(id); if(e) e.textContent='';});
        ['match_results','chat_log'].forEach(id=>{const e=document.getElementById(id); if(e) e.innerHTML='';});
      },
      showModal(){$('#modal').style.display='flex';},
      hideModal(){$('#modal').style.display='none';},
      nextFromStep2(){
        const need=['#pf_realname','#pf_age','#pf_income','#pf_height'];
        for(const sel of need){const v=$(sel).value?.trim(); if(!v){toast(i18n.t('toastProfileIncomplete'));return;}}
        const mb=$('#pf_mbti').value; if(!mb){toast(i18n.t('toastSelectMBTI'));return;}
        data.saveProfile(); ui.go('prefs');
      }
    };

    (()=>{
      const modal=document.getElementById('modal');
      const inner=modal?.querySelector('.inner');
      let lastFocused=null;
      function trap(e){
        if(e.key==='Tab'){
          const f=inner.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])');
          const focusables=Array.from(f).filter(el=>!el.disabled && el.offsetParent!==null);
          if(!focusables.length) return;
          const first=focusables[0], last=focusables[focusables.length-1];
          if(e.shiftKey && document.activeElement===first){ e.preventDefault(); last.focus(); }
          else if(!e.shiftKey && document.activeElement===last){ e.preventDefault(); first.focus(); }
        } else if(e.key==='Escape'){
          ui.hideModal();
        }
      }
      const oldShow=ui.showModal, oldHide=ui.hideModal;
      ui.showModal=()=>{
        lastFocused=document.activeElement;
        modal.style.display='flex';
        inner.setAttribute('tabindex','-1');
        inner.focus();
        document.addEventListener('keydown',trap);
      };
      ui.hideModal=()=>{
        modal.style.display='none';
        document.removeEventListener('keydown',trap);
        if(lastFocused) lastFocused.focus();
      };
    })();

    // ---- MBTI options ----
    const MBTIs=["INTJ","INTP","ENTJ","ENTP","INFJ","INFP","ENFJ","ENFP","ISTJ","ISFJ","ESTJ","ESFJ","ISTP","ISFP","ESTP","ESFP"];
    function fillMBTI(){
      const sel=$('#pf_mbti');
      const sel2=$('#pr_mbti');
      MBTIs.forEach(x=>{const o=document.createElement('option');o.text=x;o.value=x;sel.appendChild(o)});
      MBTIs.forEach(x=>{const o=document.createElement('option');o.text=x;o.value=x;sel2.appendChild(o)});
    }

    // ---- Personality Matrix ----
    const MATRIX={
      "의사소통":["공감을 잘하는","외향적인","내성적인","다정한","설득력 있는","센스 있는","애교 있는","예의 바른","재미있는","조력적인"],
      "자기개발":["개인적인","고상한","대담한","부지런한","야심만만한","열정적인","영적인","재능 있는","전문적인"],
      "문제해결":["감각적","객관적인","격정적인","경계심이 강한","관찰력이 뛰어난","긍정적인","기발한","끈기 있는","모험심이 강한"],
      "팀워크":["감성적","겸손한","고마워할 줄 아는","놀기 좋아하는","느긋한","다가가기 쉬운","사심이 없는","순종적인","우호적인","위트 있는"],
      "리더십":["결단력 있는","관대한","관용적인","매력적인","영감을 주는","온화한","자비로운","잘 보살피는","중심이 잡힌","침착한"],
      "직업윤리":["건전한","꼼꼼한","낙천적인","명예를 중시하는","반듯한","방어적인","보수적인","사회적 인식이 높은","소박한","순수한"]
    };

    const MATRIX_CAT_JA={
      "의사소통":"コミュニケーション",
      "자기개발":"自己開発",
      "문제해결":"問題解決",
      "팀워크":"チームワーク",
      "리더십":"リーダーシップ",
      "직업윤리":"職業倫理"
    };

    const MATRIX_TAG_JA={
      "의사소통":{
        "공감을 잘하는":"共感力が高い",
        "외향적인":"外向的",
        "내성적인":"内向的",
        "다정한":"優しい",
        "설득력 있는":"説得力のある",
        "센스 있는":"センスがある",
        "애교 있는":"愛嬌がある",
        "예의 바른":"礼儀正しい",
        "재미있는":"面白い",
        "조력적인":"サポート上手"
      },
      "자기개발":{
        "개인적인":"個人的",
        "고상한":"上品な",
        "대담한":"大胆な",
        "부지런한":"勤勉な",
        "야심만만한":"野心的な",
        "열정적인":"情熱的な",
        "영적인":"スピリチュアル",
        "재능 있는":"才能がある",
        "전문적인":"プロフェッショナル"
      },
      "문제해결":{
        "감각적":"感覚的",
        "객관적인":"客観的",
        "격정적인":"情熱的",
        "경계심이 강한":"警戒心が強い",
        "관찰력이 뛰어난":"観察力が高い",
        "긍정적인":"前向き",
        "기발한":"斬新な",
        "끈기 있는":"粘り強い",
        "모험심이 강한":"冒険心が強い"
      },
      "팀워크":{
        "감성적":"感情豊か",
        "겸손한":"謙虚な",
        "고마워할 줄 아는":"感謝を忘れない",
        "놀기 좋아하는":"遊び好き",
        "느긋한":"のんびりした",
        "다가가기 쉬운":"親しみやすい",
        "사심이 없는":"利他的",
        "순종적인":"従順な",
        "우호적인":"友好的",
        "위트 있는":"ウィットに富む"
      },
      "리더십":{
        "결단력 있는":"決断力がある",
        "관대한":"寛大な",
        "관용적인":"寛容な",
        "매력적인":"魅力的",
        "영감을 주는":"インスピレーションを与える",
        "온화한":"穏やかな",
        "자비로운":"慈悲深い",
        "잘 보살피는":"面倒見が良い",
        "중심이 잡힌":"芯がある",
        "침착한":"落ち着いている"
      },
      "직업윤리":{
        "건전한":"健全な",
        "꼼꼼한":"几帳面な",
        "낙천적인":"楽天的",
        "명예를 중시하는":"名誉を重んじる",
        "반듯한":"真面目な",
        "방어적인":"防御的",
        "보수적인":"保守的",
        "사회적 인식이 높은":"社会的認知が高い",
        "소박한":"素朴な",
        "순수한":"純粋な"
      }
    };

    function buildMatrix(containerId,key){
      const wrap=$(containerId);
      wrap.innerHTML='';
      Object.entries(MATRIX).forEach(([cat,tags])=>{
        const catLabel=i18n.lang==='ja'?(MATRIX_CAT_JA[cat]||cat):cat;
        const box=el('div',{class:'card'});
        box.appendChild(el('h3',{html:catLabel}));
        const list=el('div',{class:'list'});
        tags.forEach(tag=>{
          const label=i18n.lang==='ja'?(MATRIX_TAG_JA[cat]?.[tag]||tag):tag;
          const id=`${key}:${cat}:${tag}`;
          const item=el('label',{class:'pill'});
          const txt=el('span',{html:label});
          const cb=el('input',{type:'checkbox',id});
          cb.addEventListener('change',()=>limitCategory(key,cat,3,id));
          item.appendChild(txt); item.appendChild(cb);
          list.appendChild(item);
        });
        box.appendChild(list);wrap.appendChild(box);
      });
    }
    const limitCategory=(key,cat,max,id)=>{
      const cbs=[...document.querySelectorAll(`input[id^="${key}:${cat}:"]`)];
      const selected=cbs.filter(x=>x.checked);
      if(selected.length>max){
        const last=document.getElementById(id);
        last.checked=false;
        const catLabel=i18n.lang==='ja'?(MATRIX_CAT_JA[cat]||cat):cat;
        toast(i18n.lang==='ja'?`${catLabel}は最大${max}個まで`:`${catLabel}는 최대 ${max}개`);
      }
    };
    const matrix={
      clear(){document.querySelectorAll('input[id^="self:"]').forEach(x=>x.checked=false);},
      read(){const out={};Object.keys(MATRIX).forEach(cat=>{out[cat]=[...document.querySelectorAll(`input[id^="self:${cat}:"]`)].filter(x=>x.checked).map(x=>x.id.split(':').pop())});return out;}
    };
    const matrixPref={
      clear(){document.querySelectorAll('input[id^="pref:"]').forEach(x=>x.checked=false);},
      read(){const out={};Object.keys(MATRIX).forEach(cat=>{out[cat]=[...document.querySelectorAll(`input[id^="pref:${cat}:"]`)].filter(x=>x.checked).map(x=>x.id.split(':').pop())});return out;}
    };

    function applyMatrixSelections(prefix,data){
      if(!data) return;
      Object.entries(data).forEach(([cat,tags])=>{
        (tags||[]).forEach(tag=>{
          const cb=document.getElementById(`${prefix}:${cat}:${tag}`);
          if(cb) cb.checked=true;
        });
      });
    }

    function rebuildMatrices(){
      const selfSel=matrix.read();
      const prefSel=matrixPref.read();
      buildMatrix('#matrix','self');
      buildMatrix('#matrixPref','pref');
      Object.entries(selfSel).forEach(([cat,tags])=>{tags.forEach(tag=>{const cb=document.getElementById(`self:${cat}:${tag}`); if(cb) cb.checked=true;});});
      Object.entries(prefSel).forEach(([cat,tags])=>{tags.forEach(tag=>{const cb=document.getElementById(`pref:${cat}:${tag}`); if(cb) cb.checked=true;});});
    }

    // ---- Data save/load ----
    const data={
      loadProfile(){
        const email=store.get('session');
        if(!email) return;
        const p=store.get('profiles',{})[email];
        if(!p) return;
        $('#pf_realname').value=p.realname||'';
        $('#pf_age').value=p.age||'';
        $('#pf_job').value=p.job||'';
        $('#pf_income').value=p.income||'';
        $('#pf_height').value=p.height||'';
        $('#pf_body').value=p.body||'';
        $('#pf_mbti').value=p.mbti||'';
        $('#pf_religion').value=p.religion||'';
        $('#pf_edu').value=p.edu||'';
        $('#pf_smoke').value=p.smoke||'';
        $('#pf_drink').value=p.drink||'';
        $('#pf_child').value=p.child||'';
        $('#pf_hobby').value=p.hobby||'';
        $('#pf_bio').value=p.bio||'';
        if(p.photo) $('#pf_avatar').src=p.photo;
        document.querySelectorAll('input[id^="self:"]').forEach(cb=>cb.checked=false);
        applyMatrixSelections('self',p.matrix);
        if(p.country) $('#ob_country').value=p.country;
        if(p.gender) $('#ob_gender').value=p.gender;
        if(p.birthYear) $('#ob_birth').value=p.birthYear;
      },
      loadPrefs(){
        const email=store.get('session');
        if(!email) return;
        const pref=store.get('prefs',{})[email];
        if(!pref) return;
        $('#pr_age_type').value=pref.ageType||'';
        $('#pr_age_min').value=pref.ageMin||'';
        $('#pr_age_max').value=pref.ageMax||'';
        $('#pr_income_min').value=pref.incomeMin||'';
        $('#pr_height_min').value=pref.heightMin||'';
        $('#pr_height_max').value=pref.heightMax||'';
        $('#pr_body').value=pref.body||'';
        $('#pr_mbti').value=pref.mbti||'무관';
        $('#pr_hobby').value=pref.hobby||'';
        $('#pr_deal').checked=!!pref.deal;
        document.querySelectorAll('input[id^="pref:"]').forEach(cb=>cb.checked=false);
        applyMatrixSelections('pref',pref.matrix);
      },
      saveProfile(){
        const email=store.get('session');
        if(!email){toast(i18n.t('toastLoginNeeded'));return;}
        const profile={
          realname:$('#pf_realname').value,
          age:+$('#pf_age').value||null,
          job:$('#pf_job').value,
          income:+$('#pf_income').value||null,
          height:+$('#pf_height').value||null,
          body:$('#pf_body').value,
          mbti:$('#pf_mbti').value,
          religion:$('#pf_religion').value,
          edu:$('#pf_edu').value,
          smoke:$('#pf_smoke').value,
          drink:$('#pf_drink').value,
          child:$('#pf_child').value,
          hobby:$('#pf_hobby').value,
          bio:$('#pf_bio').value,
          matrix:matrix.read(),
          country:$('#ob_country')?.value,
          gender:$('#ob_gender')?.value,
          birthYear:+$('#ob_birth')?.value||null,
          photo:store.get('tmp_photo_'+email)
        };
        const db=store.get('profiles',{});
        db[email]=profile;
        store.set('profiles',db);
        toast(i18n.t('toastProfileSaved'));
        alert(i18n.t('alertProfileSaved'));
        ui.homeCTA();
      },
      savePrefs(){
        const email=store.get('session');
        if(!email){toast(i18n.t('toastLoginNeeded'));return;}
        const ageMin=$('#pr_age_min').value, ageMax=$('#pr_age_max').value;
        if(!ageMin||!ageMax){toast(i18n.t('toastAgeRange'));return;}
        const prefs={
          ageType:$('#pr_age_type').value,
          ageMin:+ageMin,
          ageMax:+ageMax,
          incomeMin:+($('#pr_income_min').value)||0,
          heightMin:+($('#pr_height_min').value)||null,
          heightMax:+($('#pr_height_max').value)||null,
          body:$('#pr_body').value,
          mbti:$('#pr_mbti').value,
          hobby:$('#pr_hobby').value,
          matrix:matrixPref.read(),
          deal:$('#pr_deal').checked
        };
        const db=store.get('prefs',{});
        db[email]=prefs;
        store.set('prefs',db);
        toast(i18n.t('toastPrefsSaved'));
        ui.homeCTA();
        ui.go('match');
      }
    };

    // photo preview
    window.addEventListener('change',e=>{
      if(e.target && e.target.id==='pf_photo'){
        const f=e.target.files?.[0];
        if(!f) return;
        if(!/^image\//.test(f.type)){ toast(i18n.t('toastImageType')); return; }
        if(f.size > 2*1024*1024){ toast(i18n.t('toastImageSize')); return; }
        const r=new FileReader();
        r.onload=()=>{store.set('tmp_photo_'+store.get('session'),r.result);$('#pf_avatar').src=r.result};
        r.readAsDataURL(f);
      }
    });

    // ---- Matching Engine (mock) ----
    const engine={
      score(me,pref,other){
        if(!other||!other.profile) return -1;
        const p=other.profile; let s=0;
        if(pref.heightMin && p.height>=pref.heightMin) s+=5;
        if(pref.heightMax && p.height<=pref.heightMax) s+=5;
        if(p.income && p.income>=(pref.incomeMin||0)) s+=6;
        if(pref.body && pref.body!=='무관' && p.body===pref.body) s+=4;
        const comp={"INTJ":["ENFP","ENTP"],"ENFP":["INTJ","INFJ"],"ISTJ":["ENFP","ESFP"],"ENFJ":["INFP","ISFP"]};
        if(pref.mbti && pref.mbti!=='무관'){
          if(p.mbti===pref.mbti) s+=4;
          if((comp[pref.mbti]||[]).includes(p.mbti)) s+=2;
        }
        const inter=(a,b)=>Object.keys(a).reduce((acc,k)=>acc+ a[k].filter(x=>b[k]?.includes(x)).length,0);
        s+= inter(pref.matrix,p.matrix)*2;
        if(pref.hobby && p.hobby && p.hobby.toLowerCase().includes(pref.hobby.toLowerCase())) s+=3;
        if(pref.deal){
          const ok=Object.keys(pref.matrix).every(k=>pref.matrix[k].length===0 || pref.matrix[k].some(t=>p.matrix[k]?.includes(t)));
          if(!ok) return -1;
        }
        return s;
      },
      match(){
        if(!store.get('session')){toast(i18n.t('toastLoginNeeded'));return;}
        $('#match_results').innerHTML='<p class="help">운영자가 매칭을 진행할 때까지 기다려 주세요.</p>';
      }
    };

    // ---- Chat + Meeting (mock) ----
    const chat={
      async send(){
        const box=$('#chat_input');
        const txt=box.value.trim();
        if(!txt) return;
        box.value='';
        if(!window.__CURRENT_CONV_ID__) return;
        await sendMessage(window.__CURRENT_CONV_ID__, txt, detect(txt));
        renderMessage({ sender: window.__CURRENT_UID__, text: txt });
      },
      requestMeet(type){
        const st={type,status:'대기',ts:Date.now()};
        store.set('meet_req',st);
        $('#meet_status').textContent=i18n.t(type==='offline'?'meetOfflineStatus':'meetOnlineStatus');
      }
    };
    function detect(t){return /[ぁ-んァ-ヶ一-龯]/.test(t)?'JA':/[가-힣]/.test(t)?'KO':'EN'}
    function escapeHtml(s){return s.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]))}


    // ---- Init ----
    function init(){
      fillMBTI();
      buildMatrix('#matrix','self');
      buildMatrix('#matrixPref','pref');
      const savedLang = store.get('lang','ko');
      i18n.set(savedLang);
      const langSel=document.getElementById('langSel');
      if(langSel) langSel.addEventListener('change',e=>i18n.set(e.target.value));
      ui.refreshNav();
      ui.homeCTA();
      afterSignInHook();
      const lastEmail=store.get('last_email','');
      const lastPw=store.get('last_pw','');
      if(document.getElementById('li_email')) document.getElementById('li_email').value=lastEmail;
      if(document.getElementById('li_pw')) document.getElementById('li_pw').value=lastPw;
      if(document.getElementById('su_email')) document.getElementById('su_email').value=lastEmail;
      if(sb?.auth){
        sb.auth.onAuthStateChange((_e, session)=>{
          if(session) afterSignInHook(session.user); else beforeSignOutHook();
        });
      }
      ui.go('home');
      $('#userBadge').setAttribute('role','button');
      $('#userBadge').addEventListener('click',()=>{ if(!store.get('session')) ui.openAuth(); });
      bindEnter('#li_email, #li_pw', auth.login);
      bindEnter('#su_email, #su_nick, #su_pw', auth.signup);
      bindEnter('#su_verify_target', auth.sendCode);
      bindEnter('#su_code', auth.verifyCode);
      bindEnter('#profile input, #profile select', ui.nextFromStep2);
      bindEnter('#prefs input, #prefs select', data.savePrefs);
      const box=document.querySelector('#chat_input');
      box.addEventListener('keydown',(e)=>{
        const enterToSend=document.querySelector('#enter_send')?.checked;
        if(e.key==='Enter' && !e.shiftKey){
          if(enterToSend){
            e.preventDefault();
            chat.send();
          }
        }
      });
    }
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
